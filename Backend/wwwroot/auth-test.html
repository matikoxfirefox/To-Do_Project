<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>ToDo App z Grupami</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #todo-section { display: none; margin-top: 20px; }
        #groups { margin-bottom: 20px; }
        input, select { margin: 5px 0; }
        button { margin-left: 5px; }
    </style>
</head>
<body>
<h1>ToDo App z Grupami</h1>

<div id="auth-section">
    <h2>Rejestracja / Logowanie</h2>
    <input id="username" placeholder="username">
    <input id="password" placeholder="password" type="password">
    <br>
    <button onclick="auth('register')">Register</button>
    <button onclick="auth('login')">Login</button>
    <pre id="auth-output"></pre>
</div>

<div id="todo-section">
    <h2>Twoje grupy</h2>
    <div id="groups"></div>
    <input id="new-group" placeholder="Nowa grupa">
    <button onclick="addGroup()">Dodaj grupę</button>
    <hr>
    <h2>Taski wybranej grupy</h2>
    <select id="group-select" onchange="fetchTodos()"></select>
    <br>
    <input id="new-todo" placeholder="Nowe zadanie">
    <button onclick="addTodo()">Dodaj zadanie</button>
    <ul id="todo-list"></ul>
    <button onclick="logout()">Wyloguj</button>
</div>

<script>
    let currentUserId = getCookie("userId");
    let currentGroupId = null;

    if (currentUserId) {
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("todo-section").style.display = "block";
        fetchGroups();
    }

    async function auth(action) {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const out = document.getElementById("auth-output");
        if (!username || !password) { out.textContent = "Wypełnij wszystkie pola!"; return; }
        try {
            const res = await fetch("http://localhost:5263/api/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action, username, password })
            });
            const data = await res.json();
            if (!res.ok) { out.textContent = "Błąd: " + data.error; return; }
            currentUserId = data.id;
            setCookie("userId", currentUserId, 4);
            out.textContent = action === 'register' ? `Zarejestrowano: ${data.username}` : `Zalogowano: ${data.username}`;
            document.getElementById("auth-section").style.display = "none";
            document.getElementById("todo-section").style.display = "block";
            fetchGroups();
        } catch (err) { out.textContent = "Błąd fetch: " + err; }
    }

    async function fetchGroups() {
        const res = await fetch(`http://localhost:5263/api/users/${currentUserId}/groups`);
        const groups = await res.json();
        const groupSelect = document.getElementById("group-select");
        const groupsDiv = document.getElementById("groups");
        groupSelect.innerHTML = "";
        groupsDiv.innerHTML = "";
        groups.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g.id;
            opt.textContent = g.name;
            groupSelect.appendChild(opt);
            const div = document.createElement("div");
            div.textContent = g.name;
            groupsDiv.appendChild(div);
        });
        if(groups.length>0){
            currentGroupId = groups[0].id;
            fetchTodos();
        }
    }

    async function addGroup() {
        const name = document.getElementById("new-group").value.trim();
        if(!name) return;
        await fetch(`http://localhost:5263/api/groups`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ name, ownerId: currentUserId })
        });
        document.getElementById("new-group").value = "";
        fetchGroups();
    }

    async function fetchTodos() {
        if (!currentUserId || !currentGroupId) return;
        currentGroupId = parseInt(document.getElementById("group-select").value);
        const res = await fetch(`http://localhost:5263/api/todos/${currentUserId}?groupId=${selectedGroupId || ''}`);
        const todos = await res.json();
        const ul = document.getElementById("todo-list");
        ul.innerHTML = "";
        todos.forEach(todo => {
            const li = document.createElement("li");
            li.innerHTML = `<input type="checkbox" ${todo.isDone ? "checked" : ""} onchange="toggleDone(${todo.id}, this.checked)"> ${todo.title} <button onclick="deleteTodo(${todo.id})">Usuń</button>`;
            ul.appendChild(li);
        });
    }

    async function addTodo() {
        const title = document.getElementById("new-todo").value.trim();
        if (!title || !currentUserId || !currentGroupId) return;
        await fetch(`http://localhost:5263/api/todos/${currentUserId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, isDone: false, groupId: selectedGroupId })

        });
        document.getElementById("new-todo").value = "";
        fetchTodos();
    }

    async function deleteTodo(id) {
        await fetch(`http://localhost:5263/api/todos/${id}`, { method: "DELETE" });
        fetchTodos();
    }

    async function toggleDone(id, checked) {
        const li = document.querySelector(`#todo-list li:nth-child(${id})`);
        const title = li ? li.textContent.replace("Usuń", "").trim() : "Zadanie";
        await fetch(`http://localhost:5263/api/todos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, title, isDone: checked, groupId: currentGroupId })
        });
        fetchTodos();
    }

    function logout() {
        currentUserId = null;
        deleteCookie("userId");
        document.getElementById("auth-section").style.display = "block";
        document.getElementById("todo-section").style.display = "none";
    }

    function setCookie(name, value, hours) {
        const d = new Date();
        d.setTime(d.getTime() + (hours*60*60*1000));
        document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
    }

    function getCookie(name) {
        const cookies = document.cookie.split(";").map(c => c.trim());
        for (const c of cookies) if (c.startsWith(name+"=")) return c.split("=")[1];
        return null;
    }

    function deleteCookie(name) {
        document.cookie = name+"=;expires=Thu,01 Jan 1970 00:00:00 UTC;path=/";
    }
</script>
</body>
</html>
